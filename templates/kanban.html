<!DOCTYPE html>
<html>
<head>
    <title>Kanban Board - {{ project.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .kanban {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .kanban-column {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            min-height: 400px;
            border: 1px solid #e2e8f0;
        }

        .kanban-column h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .kanban-task {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: grab;
            border-left: 4px solid #cbd5e0;
            font-size: 0.9em;
            transition: transform 0.1s ease;
        }

        .kanban-task:hover {
            border-color: #4A90E2;
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .top-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* 1Ô∏è‚É£ Chart Styling */
        .chart-section {
            width: 150px; 
            height: 150px; 
            margin: 20px auto 40px auto;
        }

        /* Modal Styles */
        #taskModal {
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); 
            justify-content: center; 
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff; 
            padding: 30px; 
            border-radius: 12px; 
            width: 450px; 
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        #taskForm input, #taskForm select, #taskForm textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .btn-save { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-edit { background: #4A90E2; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-cancel { background: #edf2f7; color: #4a5568; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>{{ project.name }} ‚Äî Kanban Board</h2>

    <div class="top-buttons">
        <a href="{{ url_for('dashboard') }}"><button>‚Üê Back to Dashboard</button></a>
        <a href="{{ url_for('new_task', project_id=project.id) }}"><button>+ Add Task</button></a>
    </div>

    <div class="chart-section">
        <canvas id="progressChart-{{ project.id }}" width="150" height="150"></canvas>
        <p style="text-align:center; margin-top:10px; font-weight:bold; color: #4a5568;" id="progressText-{{ project.id }}">
            {{ project.progress }}% Complete
        </p>
    </div>

    <div class="kanban">
        {% for status in ['To Do', 'In Progress', 'Done'] %}
        <div class="kanban-column" data-status="{{ status }}">
            <h3>{{ status }}</h3>
            {% set tasks = todo if status == 'To Do' else (in_progress if status == 'In Progress' else done) %}
            {% for task in tasks %}
            <div class="kanban-task" draggable="true" data-id="{{ task.id }}" onclick="openTaskModal({{ task.id }})">
                <strong>{{ task.title }}</strong><br>
                <small>üë§ {{ task.assigned_to }}</small><br>
                <small>üìÖ {{ task.deadline or 'None' }}</small><br>
                <small>üö© Priority: 
                    <span style="color: {% if task.priority=='High' %}red{% elif task.priority=='Medium' %}orange{% else %}gray{% endif %}">
                        {{ task.priority or 'Low' }}
                    </span>
                </small>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<div id="taskModal">
    <div class="modal-content">
        <span style="position:absolute; top:15px; right:20px; cursor:pointer; font-size: 24px;" onclick="closeTaskModal()">&times;</span>
        <div id="taskViewMode">
            <h3 id="modalTitleView"></h3>
            <p><strong>Assigned:</strong> <span id="modalAssignedView"></span></p>
            <p><strong>Deadline:</strong> <span id="modalDeadlineView"></span></p>
            <p><strong>Status:</strong> <span id="modalStatusView"></span></p>
            <p><strong>Priority:</strong> <span id="modalPriorityView"></span></p>
            <p id="modalDescriptionView" style="background: #f7fafc; padding: 10px; border-radius: 5px; min-height: 50px;"></p>
            <button class="btn-edit" id="editTaskBtn">Edit Task</button>
        </div>

        <form id="taskForm" style="display:none;">
            <h3>Edit Task</h3>
            <input type="hidden" id="modalTaskId">
            <label>Title:</label> <input type="text" id="modalTitle" required>
            <label>Description:</label> <textarea id="modalDescription" rows="3"></textarea>
            <label>Assigned To:</label> <input type="text" id="modalAssigned" required>
            <label>Status:</label>
            <select id="modalStatus">
                <option value="To Do">To Do</option>
                <option value="In Progress">In Progress</option>
                <option value="Done">Done</option>
            </select>
            <label>Deadline:</label> <input type="date" id="modalDeadline">
            <label>Priority:</label>
            <select id="modalPriority">
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
            </select>
            <div style="margin-top: 10px;">
                <button type="submit" class="btn-save">Save Changes</button>
                <button type="button" class="btn-cancel" onclick="cancelEdit()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
let draggedTask = null;
let progressCharts = {}; // Store charts per project

// 2Ô∏è‚É£ JS ‚Äî Chart.js Initialization
function initProgressChart(projectId, done, inProgress, remaining) {
    const canvas = document.getElementById(`progressChart-${projectId}`);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // Destroy previous chart if exists
    if(progressCharts[projectId]){
        progressCharts[projectId].destroy();
    }

    progressCharts[projectId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Done', 'In Progress', 'Remaining'],
            datasets: [{
                data: [done, inProgress, remaining],
                backgroundColor: ['#FF4C4C', '#4A90E2', '#F2C94C'], // Red, Blue, Yellow
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: { font: { size: 11 } }
                }
            }
        }
    });
}

// 3Ô∏è‚É£ Update Progress function
function updateProgress(projectId){
    fetch(`/project_progress/${projectId}`)
        .then(res => res.json())
        .then(data => {
            // Note: Ensuring we use the keys returned by your Flask API
            const done = data.done || 0;
            const inProgress = data.in_progress || data.inProgress || 0; 
            const total = data.total || 0;
            const remaining = Math.max(0, total - done - inProgress);

            // Update text
            const text = document.getElementById(`progressText-${projectId}`);
            if(text) text.textContent = total > 0 ? Math.round((done / total) * 100) + '% Complete' : '0% Complete';

            // Update donut chart
            initProgressChart(projectId, done, inProgress, remaining);
        });
}

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', () => {
    updateProgress("{{ project.id }}");
});

// Drag & Drop
document.querySelectorAll('.kanban-task').forEach(task => {
    task.addEventListener('dragstart', (e) => {
        draggedTask = task;
        e.dataTransfer.setData('text/plain', task.dataset.id);
        task.style.opacity = '0.4';
    });
    task.addEventListener('dragend', () => task.style.opacity = '1');
});

document.querySelectorAll('.kanban-column').forEach(column => {
    column.addEventListener('dragover', e => e.preventDefault());
    column.addEventListener('drop', () => {
        if (!draggedTask) return;
        const status = column.getAttribute('data-status');
        column.appendChild(draggedTask);

        fetch('/update_task_status', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({task_id: draggedTask.dataset.id, status: status})
        }).then(() => updateProgress("{{ project.id }}"));

        draggedTask = null;
    });
});

// Modal Actions
function openTaskModal(taskId) {
    fetch(`/get_task/${taskId}`).then(res => res.json()).then(task => {
        document.getElementById('modalTitleView').textContent = task.title;
        document.getElementById('modalAssignedView').textContent = task.assigned_to;
        document.getElementById('modalDeadlineView').textContent = task.deadline || 'None';
        document.getElementById('modalStatusView').textContent = task.status;
        document.getElementById('modalPriorityView').textContent = task.priority || 'Low';
        document.getElementById('modalDescriptionView').textContent = task.description || 'No description.';
        
        document.getElementById('modalTaskId').value = task.id;
        document.getElementById('modalTitle').value = task.title;
        document.getElementById('modalAssigned').value = task.assigned_to;
        document.getElementById('modalStatus').value = task.status;
        document.getElementById('modalPriority').value = task.priority || 'Low';
        document.getElementById('modalDescription').value = task.description || '';
        
        document.getElementById('taskViewMode').style.display = 'block';
        document.getElementById('taskForm').style.display = 'none';
        document.getElementById('taskModal').style.display = 'flex';
    });
}

function closeTaskModal() { document.getElementById('taskModal').style.display = 'none'; }
function cancelEdit() { document.getElementById('taskForm').style.display = 'none'; document.getElementById('taskViewMode').style.display = 'block'; }
document.getElementById('editTaskBtn').onclick = () => {
    document.getElementById('taskViewMode').style.display = 'none';
    document.getElementById('taskForm').style.display = 'block';
};

document.getElementById('taskForm').onsubmit = function(e){
    e.preventDefault();
    const taskData = {
        task_id: document.getElementById('modalTaskId').value,
        title: document.getElementById('modalTitle').value,
        description: document.getElementById('modalDescription').value,
        assigned_to: document.getElementById('modalAssigned').value,
        status: document.getElementById('modalStatus').value,
        deadline: document.getElementById('modalDeadline').value,
        priority: document.getElementById('modalPriority').value
    };
    fetch('/edit_task', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(taskData)
    }).then(() => location.reload());
};
</script>
</body>
</html>